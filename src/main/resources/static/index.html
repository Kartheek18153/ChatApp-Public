<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat App</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white shadow-lg rounded-lg w-full max-w-md p-6">

  <div id="loginPage">
    <h2 class="text-2xl font-bold mb-4">Login</h2>
    <input id="loginUsername" type="text" placeholder="Username" class="border p-2 rounded w-full mb-2">
    <input id="loginPassword" type="password" placeholder="Password" class="border p-2 rounded w-full mb-2">
    <button onclick="login()" class="bg-green-500 text-white px-4 py-2 rounded w-full">Login</button>
    <p class="text-sm mt-2">Donâ€™t have an account? <a href="#" onclick="showRegister()" class="text-blue-500">Register</a></p>
    <p id="loginMsg" class="text-sm text-red-500 mt-2"></p>
  </div>

  <div id="registerPage" class="hidden">
    <h2 class="text-2xl font-bold mb-4">Register</h2>
    <input id="registerUsername" type="text" placeholder="Username" class="border p-2 rounded w-full mb-2">
    <input id="registerPassword" type="password" placeholder="Password" class="border p-2 rounded w-full mb-2">
    <input id="registerConfirm" type="password" placeholder="Confirm Password" class="border p-2 rounded w-full mb-2">
    <button onclick="register()" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Register</button>
    <p class="text-sm mt-2">Already have an account? <a href="#" onclick="showLogin()" class="text-blue-500">Login</a></p>
    <p id="registerMsg" class="text-sm text-red-500 mt-2"></p>
  </div>

  <div id="messagingPage" class="hidden flex flex-col h-[500px]">
    <h2 class="text-xl font-bold mb-2">Welcome, <span id="userDisplay"></span></h2>
    <div id="messages" class="border p-2 flex-1 overflow-y-auto bg-gray-50 rounded-lg mb-4 flex flex-col"></div>
    <div class="flex">
      <input id="messageInput" type="text" placeholder="Type your message..." class="border p-2 rounded-l-lg w-full">
      <button onclick="sendMessage()" class="bg-green-500 text-white px-4 py-2 rounded-r-lg">Send</button>
    </div>
  </div>

</div>

<script>
let ws;
let myUsername = "";

function showLogin() {
  document.getElementById("loginPage").classList.remove("hidden");
  document.getElementById("registerPage").classList.add("hidden");
  document.getElementById("messagingPage").classList.add("hidden");
}
function showRegister() {
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("registerPage").classList.remove("hidden");
  document.getElementById("messagingPage").classList.add("hidden");
}
function showMessaging() {
  document.getElementById("loginPage").classList.add("hidden");
  document.getElementById("registerPage").classList.add("hidden");
  document.getElementById("messagingPage").classList.remove("hidden");
}

async function register() {
  const username = document.getElementById("registerUsername").value.trim();
  const password = document.getElementById("registerPassword").value.trim();
  const confirm = document.getElementById("registerConfirm").value.trim();
  if(password !== confirm){ 
    document.getElementById("registerMsg").innerText="Passwords do not match!"; 
    return; 
  }

  const response = await fetch('/auth/register', { 
    method:'POST', 
    headers:{'Content-Type':'application/json'}, 
    body: JSON.stringify({username,password}) 
  });
  const data = await response.json();
  document.getElementById("registerMsg").innerText = data.message;
  if(data.success) showLogin();
}

async function login() {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  const response = await fetch('/auth/login', { 
    method:'POST', 
    headers:{'Content-Type':'application/json'}, 
    body: JSON.stringify({username,password}) 
  });
  const data = await response.json();
  document.getElementById("loginMsg").innerText = data.message;

  if(data.success){
    myUsername=username;
    document.getElementById("userDisplay").innerText=myUsername;
    showMessaging();
    startChat();
  }
}

function startChat(){
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${protocol}://${window.location.host}/chat`);

  ws.onopen = ()=>console.log("Connected to WebSocket server");

  ws.onmessage = event => {
    const msg = JSON.parse(event.data);
    const messagesDiv = document.getElementById("messages");
    const bubble = document.createElement("div");
    const time = new Date(msg.timestamp).toLocaleTimeString();

    if(msg.username === myUsername){
      bubble.className = "self-end bg-green-500 text-white px-4 py-2 rounded-2xl mb-2 max-w-xs break-words";
      bubble.textContent = `[${time}] You: ${msg.content}`;
    } else if(msg.username === "SYSTEM"){
      bubble.className = "self-center bg-yellow-200 text-black px-4 py-2 rounded-2xl mb-2 max-w-xs break-words font-bold";
      bubble.textContent = `[${time}] ${msg.content}`;
    } else {
      bubble.className = "self-start bg-gray-300 text-black px-4 py-2 rounded-2xl mb-2 max-w-xs break-words";
      bubble.textContent = `[${time}] ${msg.username}: ${msg.content}`;
    }

    messagesDiv.appendChild(bubble);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  ws.onclose = ()=>console.log("Disconnected from server");
}

function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text || !ws) return;
  ws.send(JSON.stringify({username:myUsername, content:text}));
  input.value="";
}
</script>
</body>
</html>
