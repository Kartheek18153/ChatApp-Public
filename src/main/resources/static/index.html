<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Clario Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    @keyframes gradientBG {
      0% { background-position:0% 50%;}
      50% {background-position:100% 50%;}
      100% {background-position:0% 50%;}
    }
    body {background:linear-gradient(-45deg,#4f46e5,#8b5cf6,#ec4899,#facc15);background-size:400% 400%;animation:gradientBG 15s ease infinite;}
    .fade-in {animation:fadeIn 1s ease forwards;opacity:0;}
    @keyframes fadeIn {to{opacity:1;}}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen font-sans">

<div class="bg-white bg-opacity-90 shadow-2xl rounded-xl w-full max-w-md p-8 fade-in">

  <div class="text-center mb-6">
    <div class="text-4xl font-extrabold text-indigo-600 tracking-wide">Clario</div>
    <p class="text-sm text-gray-500">Connect instantly with your friends</p>
  </div>

  <!-- Welcome Page -->
  <div id="welcomePage">
    <h2 class="text-3xl font-bold mb-4 text-gray-700 text-center fade-in">Welcome to Clario</h2>
    <p class="text-gray-600 mb-6 text-center fade-in delay-200">Real-time messaging made simple, secure, and fun.</p>
    <div class="flex justify-center space-x-4 fade-in delay-400">
      <button onclick="showLogin()" class="bg-gradient-to-r from-green-500 to-green-600 hover:scale-105 transform transition text-white px-6 py-3 rounded shadow-lg">Login</button>
      <button onclick="showRegister()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:scale-105 transform transition text-white px-6 py-3 rounded shadow-lg">Register</button>
    </div>
  </div>

  <!-- Login Page -->
  <div id="loginPage" class="hidden fade-in">
    <h2 class="text-2xl font-bold mb-4 text-gray-700">Login</h2>
    <div class="space-y-3">
      <input id="loginUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
      <div class="relative">
        <input id="loginPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <span onclick="togglePassword('loginPassword')" class="absolute right-3 top-2 text-gray-500 cursor-pointer">üëÅÔ∏è</span>
      </div>
      <button onclick="login()" class="bg-gradient-to-r from-green-500 to-green-600 hover:scale-105 transform transition text-white px-4 py-2 rounded w-full">Login</button>
    </div>
    <p class="text-sm mt-3">Don‚Äôt have an account? <a href="#" onclick="showRegister()" class="text-blue-500 hover:underline">Register</a></p>
    <p id="loginMsg" class="text-sm text-red-500 mt-2"></p>
  </div>

  <!-- Register Page -->
  <div id="registerPage" class="hidden fade-in">
    <h2 class="text-2xl font-bold mb-4 text-gray-700">Register</h2>
    <div class="space-y-3">
      <input id="registerUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
      <div class="relative">
        <input id="registerPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <span onclick="togglePassword('registerPassword')" class="absolute right-3 top-2 text-gray-500 cursor-pointer">üëÅÔ∏è</span>
      </div>
      <div class="relative">
        <input id="registerConfirm" type="password" placeholder="Confirm Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <span onclick="togglePassword('registerConfirm')" class="absolute right-3 top-2 text-gray-500 cursor-pointer">üëÅÔ∏è</span>
      </div>
      <button onclick="register()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:scale-105 transform transition text-white px-4 py-2 rounded w-full">Register</button>
    </div>
    <p class="text-sm mt-3">Already have an account? <a href="#" onclick="showLogin()" class="text-blue-500 hover:underline">Login</a></p>
    <p id="registerMsg" class="text-sm text-red-500 mt-2"></p>
  </div>

  <!-- Messaging Page -->
  <div id="messagingPage" class="hidden flex flex-col h-[500px] fade-in">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-xl font-bold text-gray-700">Welcome, <span id="userDisplay"></span></h2>
      <button onclick="logout()" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:opacity-90 transition">Logout</button>
    </div>
    <div id="messages" class="border p-3 flex-1 overflow-y-auto bg-gradient-to-r from-blue-100 via-indigo-100 to-purple-100 rounded-lg mb-4 flex flex-col shadow-inner"></div>
    <div class="flex">
      <input id="messageInput" type="text" placeholder="Type your message..." class="border p-2 rounded-l-lg w-full focus:ring focus:ring-indigo-300">
      <button onclick="sendMessage()" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white px-4 py-2 rounded-r-lg transition">Send</button>
    </div>
  </div>

  <div class="text-center text-xs text-gray-400 mt-6">¬© 2025 Clario. All rights reserved.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
let stompClient;
let myUsername = "";

function showLogin(){ document.getElementById("loginPage").classList.remove("hidden"); document.getElementById("registerPage").classList.add("hidden"); document.getElementById("messagingPage").classList.add("hidden"); document.getElementById("welcomePage").classList.add("hidden"); }
function showRegister(){ document.getElementById("loginPage").classList.add("hidden"); document.getElementById("registerPage").classList.remove("hidden"); document.getElementById("messagingPage").classList.add("hidden"); document.getElementById("welcomePage").classList.add("hidden"); }
function showMessaging(){ document.getElementById("loginPage").classList.add("hidden"); document.getElementById("registerPage").classList.add("hidden"); document.getElementById("messagingPage").classList.remove("hidden"); document.getElementById("welcomePage").classList.add("hidden"); }
function showWelcome(){ document.getElementById("loginPage").classList.add("hidden"); document.getElementById("registerPage").classList.add("hidden"); document.getElementById("messagingPage").classList.add("hidden"); document.getElementById("welcomePage").classList.remove("hidden"); }

function togglePassword(id){ const input=document.getElementById(id); input.type = input.type==="password"?"text":"password"; }

async function register(){
  const username = document.getElementById("registerUsername").value.trim();
  const password = document.getElementById("registerPassword").value.trim();
  const confirm = document.getElementById("registerConfirm").value.trim();
  if(password !== confirm){ document.getElementById("registerMsg").innerText="Passwords do not match!"; return; }
  const response = await fetch('/auth/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) });
  const message = await response.text();
  document.getElementById("registerMsg").innerText = message;
  if(message.includes("successful")) showLogin();
}

async function login(){
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  const response = await fetch('/auth/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) });
  const message = await response.text();
  document.getElementById("loginMsg").innerText = message;
  if(message.includes("successful")){ myUsername=username; document.getElementById("userDisplay").innerText=myUsername; showMessaging(); startChat(); }
}

function logout(){ myUsername=""; showWelcome(); if(stompClient) stompClient.disconnect(); document.getElementById("messages").innerHTML=""; }

function startChat(){
  const socket = new SockJS('/ws');
  stompClient = Stomp.over(socket);
  stompClient.connect({}, frame=>{
    stompClient.subscribe('/topic/messages', msg=>{
      const message = JSON.parse(msg.body);
      if(message.type==="message") appendMessage(message);
      else if(message.type==="delete") deleteMessageUI(message.id);
    });
  });
}

function appendMessage(msg){
  const messagesDiv=document.getElementById("messages");
  const wrapper=document.createElement("div"); wrapper.id="msg-"+msg.id; wrapper.className="mb-3 max-w-xs";
  const bubble=document.createElement("div"); const timeText=document.createElement("div"); timeText.className="text-[10px] text-gray-500 mt-1"; timeText.textContent=new Date(msg.timestamp).toLocaleTimeString();

  if(msg.username===myUsername){
    wrapper.classList.add("self-end","text-right");
    bubble.className="bg-green-500 text-white px-4 py-2 rounded-2xl shadow flex justify-between items-center";
    bubble.innerHTML=`You: ${msg.content} <button onclick="deleteMessage(${msg.id})" class="ml-2 text-xs bg-red-500 px-2 py-1 rounded">üóë</button>`;
  } else if(msg.username==="SYSTEM"){
    wrapper.classList.add("self-center","text-center");
    bubble.className="bg-yellow-200 text-black px-4 py-2 rounded-2xl font-bold shadow";
    bubble.textContent=msg.content;
  } else{
    wrapper.classList.add("self-start","text-left");
    bubble.className="bg-gray-300 text-black px-4 py-2 rounded-2xl shadow";
    bubble.textContent=`${msg.username}: ${msg.content}`;
  }

  wrapper.appendChild(bubble); wrapper.appendChild(timeText); messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function deleteMessageUI(id){
  const elem=document.getElementById("msg-"+id);
  if(elem){ const bubble=elem.querySelector("div"); bubble.className="bg-gray-200 text-gray-600 italic px-4 py-2 rounded-2xl shadow"; bubble.textContent="This message was deleted"; }
}

function sendMessage(){
  const text=document.getElementById("messageInput").value.trim();
  if(!text || !stompClient) return;
  fetch("/messages",{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({username:myUsername, content:text}) });
  document.getElementById("messageInput").value="";
}

function deleteMessage(id){ fetch(`/messages/${id}`,{ method:"DELETE" }); }

showWelcome();
</script>
</body>
</html>
