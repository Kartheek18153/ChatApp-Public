<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center min-h-screen font-sans">

  <div class="bg-white shadow-2xl rounded-xl w-full max-w-md p-8">

    <!-- App Logo / Title -->
    <div class="text-center mb-6">
      <div class="text-4xl font-extrabold text-indigo-600 tracking-wide">ChatApp</div>
      <p class="text-sm text-gray-500">Real-time Messaging Made Simple</p>
    </div>

    <!-- Login Page -->
    <div id="loginPage">
      <h2 class="text-2xl font-bold mb-4 text-gray-700">Login</h2>
      <div class="space-y-3">
        <input id="loginUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <input id="loginPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <button onclick="login()" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white px-4 py-2 rounded w-full transition">Login</button>
      </div>
      <p class="text-sm mt-3">Don’t have an account? 
        <a href="#" onclick="showRegister()" class="text-blue-500 hover:underline">Register</a>
      </p>
      <p id="loginMsg" class="text-sm text-red-500 mt-2"></p>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="hidden">
      <h2 class="text-2xl font-bold mb-4 text-gray-700">Register</h2>
      <div class="space-y-3">
        <input id="registerUsername" type="text" placeholder="Username" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <input id="registerPassword" type="password" placeholder="Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <input id="registerConfirm" type="password" placeholder="Confirm Password" class="border p-2 rounded w-full focus:ring focus:ring-indigo-300">
        <button onclick="register()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:opacity-90 text-white px-4 py-2 rounded w-full transition">Register</button>
      </div>
      <p class="text-sm mt-3">Already have an account? 
        <a href="#" onclick="showLogin()" class="text-blue-500 hover:underline">Login</a>
      </p>
      <p id="registerMsg" class="text-sm text-red-500 mt-2"></p>
    </div>

    <!-- Messaging Page -->
    <div id="messagingPage" class="hidden flex flex-col h-[500px]">
      <!-- Top bar -->
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-bold text-gray-700">Welcome, <span id="userDisplay"></span></h2>
        <button onclick="showLogin()" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:opacity-90 transition">Logout</button>
      </div>

      <!-- Messages area -->
      <div id="messages" class="border p-3 flex-1 overflow-y-auto bg-gradient-to-r from-blue-100 via-indigo-100 to-purple-100 rounded-lg mb-4 flex flex-col shadow-inner"></div>

      <!-- Input area -->
      <div class="flex">
        <input id="messageInput" type="text" placeholder="Type your message..." class="border p-2 rounded-l-lg w-full focus:ring focus:ring-indigo-300">
        <button onclick="sendMessage()" class="bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90 text-white px-4 py-2 rounded-r-lg transition">Send</button>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-xs text-gray-400 mt-6">
      © 2025 ChatApp. All rights reserved.
    </div>

  </div>

  <script>
    let ws;
    let myUsername = "";

    function showLogin() {
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("registerPage").classList.add("hidden");
      document.getElementById("messagingPage").classList.add("hidden");
    }
    function showRegister() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("registerPage").classList.remove("hidden");
      document.getElementById("messagingPage").classList.add("hidden");
    }
    function showMessaging() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("registerPage").classList.add("hidden");
      document.getElementById("messagingPage").classList.remove("hidden");
    }

    // --- Auth ---
    async function register() {
      const username = document.getElementById("registerUsername").value.trim();
      const password = document.getElementById("registerPassword").value.trim();
      const confirm = document.getElementById("registerConfirm").value.trim();
      if (password !== confirm) {
        document.getElementById("registerMsg").innerText = "Passwords do not match!";
        return;
      }

      const response = await fetch('/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const message = await response.text();
      document.getElementById("registerMsg").innerText = message;
      if (message.includes("successful")) showLogin();
    }

    async function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      const response = await fetch('/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const message = await response.text();
      document.getElementById("loginMsg").innerText = message;

      if (message.includes("successful")) {
        myUsername = username;
        document.getElementById("userDisplay").innerText = myUsername;
        showMessaging();
        startChat();
      }
    }

    // --- WebSocket Chat ---
    function startChat() {
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${protocol}://${window.location.host}/chat`);

      ws.onopen = () => console.log("Connected to WebSocket server");
      ws.onmessage = event => {
        const msg = JSON.parse(event.data);
        appendMessage(msg);
      };
      ws.onclose = () => console.log("Disconnected from server");
    }

    function appendMessage(msg) {
      const messagesDiv = document.getElementById("messages");

      const wrapper = document.createElement("div");
      wrapper.className = "mb-3 max-w-xs";

      const bubble = document.createElement("div");
      const timeText = document.createElement("div");
      timeText.className = "text-[10px] text-gray-500 mt-1";

      const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      if (msg.username === myUsername) {
        wrapper.classList.add("self-end", "text-right");
        bubble.className = "bg-green-500 text-white px-4 py-2 rounded-2xl shadow";
        bubble.textContent = `You: ${msg.content}`;
        timeText.textContent = time;
      } else if (msg.username === "SYSTEM") {
        wrapper.classList.add("self-center", "text-center");
        bubble.className = "bg-yellow-200 text-black px-4 py-2 rounded-2xl font-bold shadow";
        bubble.textContent = msg.content;
        timeText.textContent = time;
      } else {
        wrapper.classList.add("self-start", "text-left");
        bubble.className = "bg-gray-300 text-black px-4 py-2 rounded-2xl shadow";
        bubble.textContent = `${msg.username}: ${msg.content}`;
        timeText.textContent = time;
      }

      wrapper.appendChild(bubble);
      wrapper.appendChild(timeText);
      messagesDiv.appendChild(wrapper);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if (!text || !ws) return;
      ws.send(JSON.stringify({ username: myUsername, content: text }));
      input.value = "";
    }
  </script>
</body>
</html>
