<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clario</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-md mx-auto mt-10 p-6 bg-white rounded shadow">

<h2 class="text-xl font-bold mb-4">Welcome, <span id="userDisplay"></span></h2>

<div id="messages" class="h-64 overflow-y-auto border p-2 mb-4"></div>

<input type="text" id="messageInput" class="border p-2 w-3/4" placeholder="Type a message...">
<button onclick="sendMessage()" class="bg-green-500 text-white px-4 py-2 rounded">Send</button>

</div>

<script>
let stompClient;
let myUsername = "";

function login(username){
    myUsername=username;
    document.getElementById("userDisplay").innerText = myUsername;
    startChat();
}

function startChat(){
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, frame => {
        stompClient.subscribe('/topic/messages', msg => {
            const data = JSON.parse(msg.body);
            if(data.type==="message") appendMessage(data);
            if(data.type==="delete") deleteMessageUI(data.id);
        });
    });
}

function appendMessage(msg){
    const messagesDiv=document.getElementById("messages");
    const wrapper=document.createElement("div"); wrapper.id="msg-"+msg.id; wrapper.className="mb-2";
    const bubble=document.createElement("div"); bubble.className="p-2 rounded shadow flex justify-between";

    if(msg.username===myUsername){
        bubble.classList.add("bg-green-500","text-white");
        bubble.innerHTML=`You: ${msg.content} <button onclick="deleteMessage(${msg.id})" class="ml-2 bg-red-500 px-2 rounded text-xs">ðŸ—‘</button>`;
    } else{
        bubble.classList.add("bg-gray-300","text-black");
        bubble.textContent=`${msg.username}: ${msg.content}`;
    }

    wrapper.appendChild(bubble);
    messagesDiv.appendChild(wrapper);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage(){
    const input=document.getElementById("messageInput");
    if(!input.value.trim()) return;
    stompClient.send("/app/sendMessage", {}, JSON.stringify({username: myUsername, content: input.value}));
    input.value="";
}

function deleteMessage(id){
    fetch(`/messages/${id}`, {method:"DELETE"});
}

function deleteMessageUI(id){
    const elem=document.getElementById("msg-"+id);
    if(elem){
        elem.innerHTML="<i class='text-gray-500 italic'>This message was deleted</i>";
    }
}
</script>
</body>
</html>
