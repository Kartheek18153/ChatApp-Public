<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px; }
    .msg { margin: 5px 0; }
    .own { color: blue; }
    .other { color: green; }
    .delete { cursor: pointer; color: red; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Chat Application</h2>

  <div id="auth">
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="chat"></div>
  <input id="messageInput" placeholder="Type message...">
  <button onclick="sendMessage()">Send</button>

  <script>
    let ws, currentUser = null;

    function connectWS() {
      ws = new WebSocket("ws://" + window.location.host + "/chat");
      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const div = document.createElement("div");
        div.className = "msg " + (msg.username === currentUser ? "own" : "other");
        div.textContent = msg.username + ": " + msg.content;

        if (msg.username === currentUser) {
          const del = document.createElement("span");
          del.textContent = " [Delete]";
          del.className = "delete";
          del.onclick = () => deleteMessage(msg.id, div);
          div.appendChild(del);
        }
        document.getElementById("chat").appendChild(div);
      };
    }

    async function register() {
      let res = await fetch("/auth/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username: username.value, password: password.value})
      });
      alert(await res.text());
    }

    async function login() {
      let res = await fetch("/auth/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username: username.value, password: password.value})
      });
      let text = await res.text();
      if (text.includes("successful")) {
        currentUser = username.value;
        connectWS();
      }
      alert(text);
    }

    async function logout() {
      currentUser = null;
      ws && ws.close();
      alert("Logged out");
    }

    function sendMessage() {
      if (ws && currentUser) {
        ws.send(JSON.stringify({username: currentUser, content: messageInput.value}));
        messageInput.value = "";
      }
    }

    async function deleteMessage(id, div) {
      await fetch("/messages/" + id, {method: "DELETE"});
      div.remove();
    }
  </script>
</body>
</html>
